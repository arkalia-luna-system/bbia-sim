name: CI/CD Pipeline

on:
  push:
    branches: [main, develop, future]
  pull_request:
    branches: [main, develop, future]

jobs:
  lint:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    strategy:
      matrix:
        python-version: ["3.11", "3.12"]
    env:
      MUJOCO_GL: disable
      DISPLAY: ""
      BBIA_DISABLE_AUDIO: "1"
    steps:
      - uses: actions/checkout@v6

      - name: Clean up disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/*
          df -h

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgl1-mesa-dri libglib2.0-0 libsm6 libxext6 libxrender-dev libgomp1 libglu1-mesa portaudio19-dev python3-dev ffmpeg
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/*

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # Installer torch sÃ©parÃ©ment avec timeout augmentÃ© (gros package ~900MB)
          pip install --no-cache-dir --default-timeout=600 torch>=2.0.0 || echo "torch installation failed, continuing..."
          pip install --no-cache-dir --default-timeout=600 -e .[dev]
          pip install --no-cache-dir pytest-timeout
          # Installation optionnelle de pyaudio si disponible
          pip install --no-cache-dir pyaudio || echo "pyaudio non disponible, continuons sans"
          # Nettoyer aprÃ¨s installation
          python -m pip cache purge || true

      - name: Lint with ruff
        run: ruff check src/ tests/
        env:
          PYTHONDONTWRITEBYTECODE: 1

      - name: Format with black
        run: black --check src/ tests/
        env:
          PYTHONDONTWRITEBYTECODE: 1
        # Rejeter les PRs avec erreurs de formatage
        continue-on-error: false

      - name: Type check with mypy
        run: mypy src/
        env:
          PYTHONDONTWRITEBYTECODE: 1

      - name: Security check with Bandit
        run: |
          echo "Running Bandit with .bandit configuration"
          bandit -r src/ -c .bandit -x ".*|._*|*.pyc" -q
        env:
          PYTHONDONTWRITEBYTECODE: 1

      - name: Dependency audit with pip-audit
        run: |
          pip-audit --desc --format=json > audit-results.json || true
          # Check for CRITICAL vulnerabilities only
          if grep -q '"severity": "CRITICAL"' audit-results.json; then
            echo "âŒ CRITICAL vulnerabilities found!"
            pip-audit --desc
            exit 1
          fi
          echo "âœ… No CRITICAL vulnerabilities found"
          # Show other vulnerabilities as warnings
          if grep -q '"severity": "HIGH"' audit-results.json; then
            echo "âš ï¸ HIGH vulnerabilities found (non-blocking):"
            pip-audit --desc | grep -A 5 "HIGH"
          fi
          # Nettoyer le fichier temporaire
          rm -f audit-results.json || true

      - name: Security scan with semgrep
        run: |
          # Installer semgrep si non disponible
          if ! command -v semgrep &> /dev/null; then
            pip install --no-cache-dir semgrep
          fi
          # Scan avec rÃ¨gles par dÃ©faut (non-bloquant)
          semgrep --config=auto --json --output=artifacts/semgrep-results.json src/ || true
          # Afficher rÃ©sumÃ©
          if [ -f artifacts/semgrep-results.json ]; then
            echo "ðŸ“Š RÃ©sultats semgrep:"
            cat artifacts/semgrep-results.json | python -m json.tool | head -50 || true
          fi
        continue-on-error: true

      - name: Generate SBOM (CycloneDX)
        run: |
          # Installer cyclonedx-bom si non disponible
          pip install --no-cache-dir cyclonedx-bom || pip install --no-cache-dir cyclonedx-py
          # GÃ©nÃ©rer SBOM
          cyclonedx-py -o artifacts/sbom.json -i src/ || \
          cyclonedx-bom -o artifacts/sbom.json || \
          echo "SBOM generation failed (non-blocking)"
        continue-on-error: true

      - name: Upload security artifacts
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: security-artifacts-${{ matrix.python-version }}
          path: |
            artifacts/semgrep-results.json
            artifacts/sbom.json
          retention-days: 30
          if-no-files-found: ignore

      - name: Scan secrets with gitleaks
        continue-on-error: true
        run: |
          # Installer gitleaks si disponible
          if command -v gitleaks &> /dev/null; then
            gitleaks detect --source . --verbose --no-banner || true
          else
            echo "âš ï¸ gitleaks non disponible, installation..."
            wget -q https://github.com/gitleaks/gitleaks/releases/download/v8.18.0/gitleaks_8.18.0_linux_x64.tar.gz -O /tmp/gitleaks.tar.gz
            tar -xzf /tmp/gitleaks.tar.gz -C /tmp
            /tmp/gitleaks detect --source . --verbose --no-banner || true
            rm -f /tmp/gitleaks.tar.gz /tmp/gitleaks
          fi

      - name: Clean up after lint
        if: always()
        run: |
          find . -type d -name "__pycache__" -exec rm -r {} + || true
          find . -type d -name ".mypy_cache" -exec rm -r {} + || true
          find . -type d -name ".ruff_cache" -exec rm -r {} + || true
          python -m pip cache purge || true

  test:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    env:
      SEED: 42
      MUJOCO_GL: disable
      DISPLAY: ""
      BBIA_DISABLE_AUDIO: "1"
      BBIA_FORCE_MOCK_MODELS: "1"
      BBIA_DISABLE_VISION_MODELS: "1"
      PYTHONDONTWRITEBYTECODE: 1
    steps:
      - uses: actions/checkout@v6

      - name: Clean up disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/*
          df -h

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgl1-mesa-dri libglib2.0-0 libsm6 libxext6 libxrender-dev libgomp1 libglu1-mesa portaudio19-dev python3-dev ffmpeg
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/*

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # Installer torch sÃ©parÃ©ment avec timeout augmentÃ© (gros package ~900MB)
          pip install --no-cache-dir --default-timeout=600 torch>=2.0.0 || echo "torch installation failed, continuing..."
          pip install --no-cache-dir --default-timeout=600 -e .[test]
          pip install --no-cache-dir pytest-asyncio pytest-timeout
          # Installation optionnelle de pyaudio si disponible
          pip install --no-cache-dir pyaudio || echo "pyaudio non disponible, continuons sans"
          python -m pip cache purge || true

      - name: Clean logs and artifacts before tests
        run: |
          rm -rf logs/* artifacts/*.log artifacts/*.jsonl artifacts/*.csv || true
          find . -type d -name "__pycache__" -exec rm -r {} + || true
          find . -type f -name "*.pyc" -delete || true
          find . -type d -name ".pytest_cache" -exec rm -r {} + || true
          find . -type d -name ".mypy_cache" -exec rm -r {} + || true
          find . -type d -name ".ruff_cache" -exec rm -r {} + || true
          python -m pip cache purge || true

      - name: Run unit tests
        timeout-minutes: 45
        run: |
          export PYTHONPATH=src:$PYTHONPATH
          # OPTIMISATION CI: Limiter parallÃ©lisation pour Ã©viter surcharge RAM
          # Utiliser -x pour arrÃªter au premier Ã©chec et Ã©conomiser ressources
          # Pas de parallÃ©lisation (-n auto) pour Ã©viter surcharge mÃ©moire
          pytest -vv -m "not e2e and not slow" --cov=src/bbia_sim --cov-report=xml --cov-report=term-missing --cov-fail-under=0 --timeout=30 --maxfail=1 --log-cli-level=INFO --durations=20 --tb=short --showlocals -x
        env:
          PYTHONDONTWRITEBYTECODE: 1

      - name: Golden tests (headless)
        timeout-minutes: 10
        run: |
          export PYTHONPATH=src:$PYTHONPATH
          pytest -vv tests/test_golden_traces.py --maxfail=1 --disable-warnings --log-cli-level=INFO --durations=10 --tb=short --timeout=60
        env:
          PYTHONDONTWRITEBYTECODE: 1

      - name: Clean up before upload
        if: always()
        run: |
          find . -type d -name "__pycache__" -exec rm -r {} + || true
          find . -type d -name ".pytest_cache" -exec rm -r {} + || true
          rm -rf htmlcov/ || true
          python -m pip cache purge || true

      - name: Upload coverage
        uses: codecov/codecov-action@v5
        with:
          files: ./coverage.xml
          flags: unittests
          name: codecov-umbrella

      - name: Upload artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v5
        with:
          name: ci-artifacts
          path: |
            artifacts/**/*.jsonl
            artifacts/**/*.csv
          if-no-files-found: ignore

  test-e2e:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [lint, test]
    env:
      MUJOCO_GL: disable
      DISPLAY: ""
      BBIA_DISABLE_AUDIO: "1"
      PYTHONDONTWRITEBYTECODE: 1
      SEED: 42
    steps:
      - uses: actions/checkout@v6

      - name: Clean up disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/*
          df -h

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgl1-mesa-dri libglib2.0-0 libsm6 libxext6 libxrender-dev libgomp1 libglu1-mesa portaudio19-dev python3-dev ffmpeg
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/*

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # Installer torch sÃ©parÃ©ment avec timeout augmentÃ© (gros package ~900MB)
          pip install --no-cache-dir --default-timeout=600 torch>=2.0.0 || echo "torch installation failed, continuing..."
          pip install --no-cache-dir --default-timeout=600 -e .[test]
          pip install --no-cache-dir pytest-asyncio pytest-timeout
          # Installation optionnelle de pyaudio si disponible
          pip install --no-cache-dir pyaudio || echo "pyaudio non disponible, continuons sans"
          python -m pip cache purge || true

      - name: Clean logs before tests
        run: |
          rm -rf logs/* artifacts/*.log || true
          find . -type d -name "__pycache__" -exec rm -r {} + || true
          find . -type d -name ".pytest_cache" -exec rm -r {} + || true
          python -m pip cache purge || true
          mkdir -p logs

      - name: Start API server
        timeout-minutes: 2
        run: |
          echo "Starting BBIA-SIM API server..."
          export PYTHONPATH=src:$PYTHONPATH
          BBIA_TOKEN=bbia-secret-key-dev uvicorn src.bbia_sim.daemon.app.main:app --port 8000 --host 0.0.0.0 &
          SERVER_PID=$!
          sleep 5
          # VÃ©rifier que le serveur est bien dÃ©marrÃ©
          if ps -p $SERVER_PID > /dev/null; then
            echo "âœ… API server started (PID: $SERVER_PID)"
          else
            echo "âŒ API server failed to start"
            exit 1
          fi

      - name: Run e2e tests
        timeout-minutes: 15
        shell: bash
        run: |
          export PYTHONPATH=src:$PYTHONPATH
          echo "Running e2e tests..."
          mkdir -p logs
          # ExÃ©cuter pytest et capturer le code de sortie
          set +e
          pytest -vv -m "e2e" --timeout=60 --tb=short --maxfail=5 --log-cli-level=INFO --durations=10 --showlocals -x 2>&1 | head -c 1048576 > logs/test_run.log
          PYTEST_EXIT_CODE=${PIPESTATUS[0]}
          set -e
          echo "E2E tests completed (exit code: $PYTEST_EXIT_CODE)"
          echo "PYTEST_EXIT_CODE=$PYTEST_EXIT_CODE" >> $GITHUB_ENV

          # Ensure log file exists even if empty
          if [ ! -f logs/test_run.log ]; then
            touch logs/test_run.log
          fi

      - name: Upload test logs
        uses: actions/upload-artifact@v5
        if: always()
        with:
          name: e2e-test-logs
          path: logs/test_run.log
          retention-days: 7
          if-no-files-found: ignore

      - name: Clean up after e2e tests
        if: always()
        run: |
          # ArrÃªter le serveur API si encore en cours
          pkill -f "uvicorn.*daemon.app.main" || true
          find . -type d -name "__pycache__" -exec rm -r {} + || true
          find . -type d -name ".pytest_cache" -exec rm -r {} + || true
          python -m pip cache purge || true

      - name: Check e2e test results
        timeout-minutes: 1
        shell: bash
        run: |
          mkdir -p logs
          if [ ! -f logs/test_run.log ]; then
            echo "âš ï¸ Test log not found, creating empty log..."
            touch logs/test_run.log
            echo "No e2e tests executed" > logs/test_run.log
          fi

          echo "=== E2E Test Results (last 50 lines) ==="
          tail -n 50 logs/test_run.log
          echo "========================="

          # VÃ©rifier d'abord le code de sortie de pytest
          if [ "$PYTEST_EXIT_CODE" != "0" ] && [ -n "$PYTEST_EXIT_CODE" ]; then
            echo "âŒ pytest exited with code $PYTEST_EXIT_CODE"
            exit 1
          fi

          # VÃ©rifier aussi dans les logs (fallback)
          if grep -qiE "FAILED|ERROR|failed|error" logs/test_run.log && ! grep -qiE "passed.*failed|failed.*passed" logs/test_run.log; then
            # VÃ©rifier qu'il y a bien des tests qui ont Ã©chouÃ© (pas juste le mot dans un message)
            if grep -qiE "FAILED.*test|test.*FAILED|failed.*test|test.*failed" logs/test_run.log; then
              echo "âŒ Some e2e tests failed (detected in log)"
              exit 1
            fi
          fi

          # VÃ©rifier qu'il y a des rÃ©sultats de tests
          if grep -qiE "passed|PASSED|test.*passed" logs/test_run.log; then
            echo "âœ… All e2e tests passed"
          else
            echo "âš ï¸ No test results found in log, checking exit code..."
            if [ "$PYTEST_EXIT_CODE" = "0" ] || [ -z "$PYTEST_EXIT_CODE" ]; then
              echo "âœ… Assuming tests passed (pytest exit code was 0)"
            else
              echo "âŒ Tests may have failed (no clear results in log)"
              exit 1
            fi
          fi

  test-slow:
    runs-on: ubuntu-latest
    needs: [lint, test]
    timeout-minutes: 45
    env:
      MUJOCO_GL: disable
      DISPLAY: ""
      BBIA_DISABLE_AUDIO: "1"
      BBIA_FORCE_MOCK_MODELS: "1"
      BBIA_DISABLE_VISION_MODELS: "1"
      PYTHONDONTWRITEBYTECODE: 1
    steps:
      - uses: actions/checkout@v6

      - name: Clean up disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/*
          df -h

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgl1-mesa-dri libglib2.0-0 libsm6 libxext6 libxrender-dev libgomp1 libglu1-mesa portaudio19-dev python3-dev ffmpeg
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/*

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # Installer torch sÃ©parÃ©ment avec timeout augmentÃ© (gros package ~900MB)
          pip install --no-cache-dir --default-timeout=600 torch>=2.0.0 || echo "torch installation failed, continuing..."
          pip install --no-cache-dir --default-timeout=600 -e .[test]
          pip install --no-cache-dir pytest-asyncio pytest-timeout
          # Installation optionnelle de pyaudio si disponible
          pip install --no-cache-dir pyaudio || echo "pyaudio non disponible, continuons sans"
          python -m pip cache purge || true

      - name: Clean logs and artifacts before tests
        run: |
          rm -rf logs/* artifacts/*.log artifacts/*.jsonl artifacts/*.csv || true
          find . -type d -name "__pycache__" -exec rm -r {} + || true
          find . -type f -name "*.pyc" -delete || true
          find . -type d -name ".pytest_cache" -exec rm -r {} + || true
          find . -type d -name ".mypy_cache" -exec rm -r {} + || true
          find . -type d -name ".ruff_cache" -exec rm -r {} + || true
          python -m pip cache purge || true

      - name: Run slow tests
        timeout-minutes: 25
        run: |
          export PYTHONPATH=src:$PYTHONPATH
          # Tests slow avec timeout plus long (60s par test)
          # OPTIMISATION CI: Pas de parallÃ©lisation pour Ã©viter surcharge RAM
          pytest -vv -m "slow and not e2e" --cov=src/bbia_sim --cov-report=xml --cov-report=term-missing --cov-fail-under=0 --timeout=60 --maxfail=1 --log-cli-level=INFO --durations=20 --tb=short --showlocals -x
        env:
          PYTHONDONTWRITEBYTECODE: 1

      - name: Clean up before upload
        if: always()
        run: |
          find . -type d -name "__pycache__" -exec rm -r {} + || true
          find . -type d -name ".pytest_cache" -exec rm -r {} + || true
          rm -rf htmlcov/ || true
          python -m pip cache purge || true

      - name: Upload coverage (slow tests)
        uses: codecov/codecov-action@v5
        with:
          files: ./coverage.xml
          flags: slow-tests
          name: codecov-slow-tests

  examples:
    runs-on: ubuntu-latest
    needs: [lint, test]
    timeout-minutes: 20
    env:
      MUJOCO_GL: disable
      DISPLAY: ""
      BBIA_DISABLE_AUDIO: "1"
      PYTHONDONTWRITEBYTECODE: 1
    steps:
      - uses: actions/checkout@v6

      - name: Clean up disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/*
          df -h

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgl1-mesa-dri libglib2.0-0 libsm6 libxext6 libxrender-dev libgomp1 libglu1-mesa portaudio19-dev python3-dev ffmpeg
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/*

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # Installer torch sÃ©parÃ©ment avec timeout augmentÃ© (gros package ~900MB)
          pip install --no-cache-dir --default-timeout=600 torch>=2.0.0 || echo "torch installation failed, continuing..."
          pip install --no-cache-dir --default-timeout=600 -e ".[dev]"
          python -m pip cache purge || true

      - name: Test examples
        run: |
          export PYTHONPATH=src:$PYTHONPATH
          echo "Testing hello_sim.py..."
          python examples/hello_sim.py --duration 1

          echo "Testing behave_follow_face.py (expect connection error)..."
          timeout 5 python examples/behave_follow_face.py --token bbia-secret-key-dev --duration 2 || true

          echo "Testing goto_pose.py (expect 401 error)..."
          python examples/goto_pose.py --token dev --joint neck_yaw --pos 0.6 || true

          echo "Testing subscribe_telemetry.py (expect connection error)..."
          timeout 5 python examples/subscribe_telemetry.py --token dev --count 3 || true

          echo "âœ… All examples executed successfully"

      - name: Clean up after examples
        if: always()
        run: |
          find . -type d -name "__pycache__" -exec rm -r {} + || true
          python -m pip cache purge || true

  build:
    runs-on: ubuntu-latest
    needs: [lint, test, test-e2e, test-slow]
    timeout-minutes: 10
    env:
      PYTHONDONTWRITEBYTECODE: 1
    steps:
      - uses: actions/checkout@v6

      - name: Clean up disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/*
          df -h

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install system dependencies (minimal for build)
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential python3-dev
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/*

      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          pip install --no-cache-dir build wheel
          python -m pip cache purge || true

      - name: Build package
        run: python -m build

      - name: Check package
        run: pip install --no-cache-dir dist/*.whl

      - name: Clean up after build
        if: always()
        run: |
          rm -rf build/ dist/*.tar.gz || true
          python -m pip cache purge || true

  benchmark:
    runs-on: ubuntu-latest
    needs: [lint, test]
    timeout-minutes: 20
    env:
      MUJOCO_GL: disable
      DISPLAY: ""
      BBIA_DISABLE_AUDIO: "1"
      PYTHONDONTWRITEBYTECODE: 1
    steps:
      - uses: actions/checkout@v6

      - name: Clean up disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/*
          df -h

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgl1-mesa-dri libglib2.0-0 libsm6 libxext6 libxrender-dev libgomp1 libglu1-mesa portaudio19-dev python3-dev ffmpeg
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/*

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # Installer torch sÃ©parÃ©ment avec timeout augmentÃ© (gros package ~900MB)
          pip install --no-cache-dir --default-timeout=600 torch>=2.0.0 || echo "torch installation failed, continuing..."
          pip install --no-cache-dir --default-timeout=600 -e .[test]
          pip install --no-cache-dir pytest-timeout
          python -m pip cache purge || true

      - name: Run Performance Benchmarks
        run: |
          export PYTHONPATH=src:$PYTHONPATH
          mkdir -p artifacts
          # Exporter mÃ©triques JSONL avec p50/p95/p99
          python scripts/bbia_performance_benchmarks.py --jsonl artifacts/benchmarks.jsonl --output artifacts/benchmarks.json 2>&1 || echo "Benchmarks failed (non-blocking)"
        continue-on-error: true

      - name: Validate Performance Baselines
        run: |
          export PYTHONPATH=src:$PYTHONPATH
          mkdir -p artifacts
          # Valider contre baseline si disponible
          if [ -f artifacts/performance_baseline.jsonl ]; then
            python scripts/bbia_performance_benchmarks.py --benchmark latency --jsonl artifacts/current.jsonl --baseline artifacts/performance_baseline.jsonl --validate 2>&1 || echo "Baseline validation failed (non-blocking)"
          else
            echo "âš ï¸ Baseline non disponible, crÃ©ation baseline initial..."
            # CrÃ©er baseline initial si premiÃ¨re exÃ©cution
            if [ -f artifacts/benchmarks.jsonl ]; then
              cp artifacts/benchmarks.jsonl artifacts/performance_baseline.jsonl || true
            fi
          fi
        continue-on-error: true

      - name: Run Performance Profiling with Baseline
        run: |
          export PYTHONPATH=src:$PYTHONPATH
          mkdir -p artifacts
          # Profiling automatique avec validation baseline
          python scripts/performance_profiling.py || echo "Profiling failed (non-blocking)"
        continue-on-error: true

      - name: Clean up after benchmarks
        if: always()
        run: |
          find . -type d -name "__pycache__" -exec rm -r {} + || true
          python -m pip cache purge || true

      - name: Upload benchmark results
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: benchmark-results
          path: artifacts/benchmarks.jsonl
          retention-days: 7
          if-no-files-found: ignore

  metrics:
    runs-on: ubuntu-latest
    needs: [test]
    if: github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/main'
    timeout-minutes: 10
    env:
      PYTHONDONTWRITEBYTECODE: 1
      MUJOCO_GL: disable
      DISPLAY: ""
      BBIA_DISABLE_AUDIO: "1"
    steps:
      - uses: actions/checkout@v6

      - name: Clean up disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/*
          df -h

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies (minimal)
        run: |
          python -m pip install --upgrade pip
          # Installer flit_core pour rÃ©soudre l'erreur BackendUnavailable
          pip install --no-cache-dir flit_core build
          # Workaround: installer avec --no-build-isolation pour contourner l'erreur de classifier de licence dÃ©prÃ©ciÃ©
          pip install --no-cache-dir --no-build-isolation git+https://github.com/arkalia-luna-system/arkalia-metrics-collector.git || \
          pip install --no-cache-dir --no-build-isolation --no-deps git+https://github.com/arkalia-luna-system/arkalia-metrics-collector.git
          pip install --no-cache-dir defusedxml

      - name: Collect metrics
        run: |
          export PYTHONPATH=src:$PYTHONPATH
          chmod +x scripts/collect_metrics.sh
          ./scripts/collect_metrics.sh

      - name: Update METRICS.md
        run: |
          export PYTHONPATH=src:$PYTHONPATH
          python3 scripts/update_metrics_doc.py

      - name: Clean up after metrics
        if: always()
        run: |
          rm -rf metrics/*.html metrics/*.csv metrics/*.yaml metrics/._* || true
          find . -type d -name "__pycache__" -exec rm -r {} + || true
          python -m pip cache purge || true

      - name: Commit metrics update (no push - requires manual review)
        if: github.ref == 'refs/heads/develop'
        run: |
          # Note: Push automatique dÃ©sactivÃ© pour Ã©viter erreurs de permission
          # Les mÃ©triques sont sauvegardÃ©es dans les artifacts et peuvent Ãªtre commitÃ©es manuellement si nÃ©cessaire
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add docs/reference/METRICS.md metrics/*.json metrics/*.md 2>/dev/null || true
          # Ne pas push automatiquement - les mÃ©triques sont dans les artifacts
          echo "âœ… MÃ©triques mises Ã  jour (disponibles dans artifacts)"
