name: Deploy Android to Google Play

on:
    push:
        branches: [main, develop, future]
        tags:
            - "android-v*"
    workflow_dispatch:
        inputs:
            track:
                description: "Release track (internal, alpha, beta, production)"
                required: true
                default: "internal"
                type: choice
                options:
                    - internal
                    - alpha
                    - beta
                    - production

jobs:
    deploy:
        runs-on: ubuntu-latest
        timeout-minutes: 30

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Java
              uses: actions/setup-java@v5
              with:
                  distribution: "temurin"
                  java-version: "17"

            - name: Set up Flutter
              uses: subosito/flutter-action@v2
              with:
                  flutter-version: "3.35.3"
                  channel: "stable"
                  cache: true

            - name: Get Flutter dependencies
              run: flutter pub get

            - name: Verify Flutter installation
              run: flutter doctor -v

            - name: Build Android App Bundle
              run: |
                  flutter build appbundle --release \
                    --build-name=$(echo ${{ github.ref_name }} | sed 's/android-v//') \
                    --build-number=${{ github.run_number }}
              env:
                  ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
                  ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
                  ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}

            - name: Verify AAB file exists
              run: |
                  if [ ! -f build/app/outputs/bundle/release/app-release.aab ]; then
                    echo "âŒ AAB file not found!"
                    exit 1
                  fi
                  echo "âœ… AAB file found:"
                  ls -lh build/app/outputs/bundle/release/app-release.aab

            - name: Upload to Google Play Store
              uses: r0adkll/upload-google-play@v1
              with:
                  serviceAccountJsonPlainText: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}
                  packageName: com.arkalia.cia
                  releaseFiles: build/app/outputs/bundle/release/app-release.aab
                  track: ${{ github.event.inputs.track || 'internal' }}
                  status: completed
                  inAppUpdatePriority: 2
                  # âš ï¸ IMPORTANT: Cette action nÃ©cessite que l'API soit activÃ©e
                  # Si l'API n'est pas activÃ©e, cette Ã©tape Ã©chouera avec l'erreur que vous avez vue
                  # Solution: Activer l'API manuellement OU utiliser une alternative
              continue-on-error: false

            - name: Upload AAB as artifact (fallback)
              if: failure()
              uses: actions/upload-artifact@v4
              with:
                  name: android-app-bundle
                  path: build/app/outputs/bundle/release/app-release.aab
                  retention-days: 30

            - name: Summary
              if: always()
              run: |
                  echo "## ðŸ“¦ RÃ©sumÃ© du dÃ©ploiement" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "**Paquet** : com.arkalia.cia" >> $GITHUB_STEP_SUMMARY
                  echo "**Piste** : ${{ github.event.inputs.track || 'internal' }}" >> $GITHUB_STEP_SUMMARY
                  echo "**Version de Flutter** : 3.35.3" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  if [ "${{ job.status }}" == "success" ]; then
                    echo "âœ… **Statut** : DÃ©ployÃ© sur Play Store" >> $GITHUB_STEP_SUMMARY
                    echo "" >> $GITHUB_STEP_SUMMARY
                    echo "Ã‰tapes suivantes : Aucune - DÃ©ploiement automatique rÃ©ussi !" >> $GITHUB_STEP_SUMMARY
                  else
                    echo "âŒ **Statut** : Ã‰chec du dÃ©ploiement" >> $GITHUB_STEP_SUMMARY
                    echo "" >> $GITHUB_STEP_SUMMARY
                    echo "**Raison** : VÃ©rifiez les logs ci-dessus" >> $GITHUB_STEP_SUMMARY
                    echo "" >> $GITHUB_STEP_SUMMARY
                    echo "**Solution** :" >> $GITHUB_STEP_SUMMARY
                    echo "1. Activez l'API Google Play Android Developer : https://console.developers.google.com/apis/api/androidpublisher.googleapis.com/overview?project=1062485264410" >> $GITHUB_STEP_SUMMARY
                    echo "2. VÃ©rifiez que le service account JSON est correct" >> $GITHUB_STEP_SUMMARY
                    echo "3. Attendez quelques minutes aprÃ¨s activation de l'API" >> $GITHUB_STEP_SUMMARY
                  fi
